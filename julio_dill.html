<script type="module">
    // Importa os módulos do Firebase
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
    import { getFirestore, doc, setDoc, getDoc, updateDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

    // Configuração do Firebase
    const firebaseConfig = {
        apiKey: "AIzaSyCNidw_VCAVleo0UxTzVkqQhEYXfshB5tk",
        authDomain: "avaliacao-contabilizar.firebaseapp.com",
        projectId: "avaliacao-contabilizar",
        storageBucket: "avaliacao-contabilizar.firebasestorage.app",
        messagingSenderId: "934194892065",
        appId: "1:934194892065:web:f8654e039343b38ee38260"
    };

    // Inicializa o Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Função para normalizar nomes (remover espaços)
    function normalizarNome(nome) {
        return nome.replace(/\s+/g, '');
    }

    // Função para obter parâmetros da URL
    function getQueryParam(param) {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get(param);
    }

    // Obtém os parâmetros cliente, empresa e token da URL
    const clienteId = getQueryParam('cliente');
    const empresa = normalizarNome(getQueryParam('empresa'));
    const token = getQueryParam('token');

    // Valida se os parâmetros estão presentes
    if (!clienteId || !empresa || !token) {
        alert('Erro: Link inválido ou incompleto. Contate o administrador.');
        document.body.innerHTML = '<h1>Link Inválido</h1><p>Por favor, use um link válido fornecido pelo funcionário.</p>';
        throw new Error('Parâmetros inválidos na URL');
    }

    // Lógica do Carrossel
    const slides = document.querySelectorAll('.carousel-slide');
    const slidesContainer = document.getElementById('carouselSlides');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const carouselNav = document.getElementById('carouselNav');
    const carousel = document.getElementById('carousel');
    const ratingSection = document.getElementById('ratingSection');
    let currentSlide = 0;

    // Verifica se os elementos existem
    console.log('slides:', slides.length);
    console.log('slidesContainer:', slidesContainer);
    console.log('carousel:', carousel);
    console.log('ratingSection:', ratingSection);

    // Mapeamento de valores para legendas
    const ratingLabels = {
        1: { text: 'Muito ruim', class: 'very-bad' },
        2: { text: 'Ruim', class: 'bad' },
        3: { text: 'Mediano', class: 'average' },
        4: { text: 'Bom', class: 'good' },
        5: { text: 'Muito bom', class: 'very-good' }
    };

    function updateCarousel() {
        console.log(`Atualizando carrossel. Slide atual: ${currentSlide}/${slides.length - 1}`);
        if (!slidesContainer) {
            console.error('slidesContainer não encontrado!');
            return;
        }
        slidesContainer.style.transform = `translateX(-${currentSlide * 100}%)`;
        prevBtn.disabled = currentSlide === 0;
        nextBtn.disabled = !isSlideAnswered(currentSlide);
        if (currentSlide === slides.length - 1) {
            console.log("Exibindo slide de agradecimento. Escondendo navegação.");
            carouselNav.classList.add('hidden');
        } else {
            console.log("Mostrando navegação.");
            carouselNav.classList.remove('hidden');
            if (currentSlide === slides.length - 2 && isSlideAnswered(currentSlide)) {
                nextBtn.textContent = 'Finalizar';
            } else {
                nextBtn.textContent = 'Próximo';
            }
        }
    }

    function isSlideAnswered(slideIndex) {
        if (slideIndex === slides.length - 1) {
            console.log("Slide de agradecimento, não precisa de resposta.");
            return true;
        }
        const slide = slides[slideIndex];
        const ratingInputs = slide.querySelectorAll(`input[name="q${slideIndex + 1}"]`);
        const answered = Array.from(ratingInputs).some(input => input.checked);
        console.log(`Pergunta ${slideIndex + 1} respondida: ${answered}`);
        return answered;
    }

    function updateLegend(slideIndex, value) {
        const legend = document.getElementById(`q${slideIndex + 1}-legend`);
        if (legend) {
            if (value && ratingLabels[value]) {
                legend.textContent = ratingLabels[value].text;
                legend.className = `rating-legend ${ratingLabels[value].class} show`;
            } else {
                legend.textContent = '';
                legend.className = 'rating-legend';
            }
        }
    }

    function updateFinalLegend(value) {
        const legend = document.getElementById('final-legend');
        if (legend) {
            if (value && ratingLabels[value]) {
                legend.textContent = ratingLabels[value].text;
                legend.className = `rating-legend ${ratingLabels[value].class} show`;
            } else {
                legend.textContent = '';
                legend.className = 'rating-legend';
            }
        }
    }

    slides.forEach((slide, index) => {
        if (index === slides.length - 1) return; // Ignora o slide de agradecimento
        const ratingInputs = slide.querySelectorAll(`input[name="q${index + 1}"]`);
        ratingInputs.forEach(input => {
            input.addEventListener('change', () => {
                if (currentSlide === index) {
                    nextBtn.disabled = !isSlideAnswered(currentSlide);
                    updateLegend(index, input.value);
                }
            });
        });
    });

    const finalRatingInputs = document.querySelectorAll('input[name="nota"]');
    finalRatingInputs.forEach(input => {
        input.addEventListener('change', () => {
            updateFinalLegend(input.value);
        });
    });

    prevBtn.addEventListener('click', () => {
        if (currentSlide > 0) {
            currentSlide--;
            updateCarousel();
        }
    });

    nextBtn.addEventListener('click', () => {
        if (currentSlide < slides.length - 2) {
            currentSlide++;
            updateCarousel();
        } else if (currentSlide === slides.length - 2 && isSlideAnswered(currentSlide)) {
            carousel.style.display = 'none';
            ratingSection.style.display = 'block';
        }
    });

    updateCarousel();

    // Lógica de envio da avaliação
    const funcionarioId = "julio_dill";
    const form = document.getElementById('ratingSection');
    const successMsg = document.getElementById('successMsg');

    document.getElementById('submitBtn').addEventListener('click', async (e) => {
        e.preventDefault();
        console.log("Botão de envio clicado.");

        const nota = document.querySelector('input[name="nota"]:checked')?.value;
        const comentario = document.getElementById('comentario').value;

        const respostas = {};
        for (let i = 1; i <= 5; i++) {
            const resposta = document.querySelector(`input[name="q${i}"]:checked`)?.value || '';
            respostas[`pergunta${i}`] = parseInt(resposta) || 0;
        }

        if (!nota) {
            console.log("Nota geral não selecionada.");
            alert('Por favor, selecione uma nota geral.');
            return;
        }

        const avaliacao = {
            cliente: clienteId,
            respostas: respostas,
            nota: parseInt(nota),
            comentario: comentario || '',
            data: serverTimestamp()
        };

        try {
            // Verifica o token
            const tokenRef = doc(db, 'tokens', token);
            const tokenDoc = await getDoc(tokenRef);

            if (!tokenDoc.exists()) {
                console.log("Token não existe.");
                alert('Link inválido ou expirado.');
                return;
            }

            const tokenData = tokenDoc.data();
            console.log('Dados do token:', tokenData);

            if (tokenData.cliente !== clienteId || tokenData.empresa !== empresa || tokenData.funcionario !== funcionarioId) {
                console.log("Token inválido para cliente, empresa ou funcionário.");
                alert('Link inválido para este cliente, empresa ou funcionário.');
                return;
            }

            if (tokenData.usado) {
                console.log("Token já foi usado.");
                alert('Este link já foi utilizado para uma avaliação.');
                return;
            }

            // Salva a avaliação
            console.log("Salvando avaliação...");
            const evaluationId = `avaliacao_${Date.now()}`;
            const docRef = doc(db, "avaliacoes", empresa, funcionarioId, evaluationId);
            await setDoc(docRef, avaliacao);

            // Marca o token como usado
            console.log("Marcando token como usado...");
            await updateDoc(tokenRef, { usado: true });

            console.log("Avaliação salva com sucesso!");
            document.getElementById('submitBtn').disabled = true;
            successMsg.style.display = 'block';

            // Após 2 segundos, força a exibição do slide de agradecimento
            setTimeout(() => {
                console.log("Executando transição para o slide de agradecimento...");
                if (!carousel || !ratingSection) {
                    console.error("carousel ou ratingSection não encontrados!");
                    return;
                }
                successMsg.style.display = 'none';
                form.reset(); // Reseta o formulário
                document.getElementById('submitBtn').disabled = false;
                ratingSection.style.display = 'none'; // Esconde a seção de avaliação
                carousel.style.display = 'block'; // Mostra o carrossel
                currentSlide = slides.length - 1; // Define o slide de agradecimento
                console.log(`Definindo currentSlide para ${currentSlide}`);
                updateCarousel(); // Atualiza o carrossel
            }, 2000);
        } catch (error) {
            console.error("Erro ao salvar a avaliação:", error);
            alert('Erro ao enviar a avaliação. Tente novamente.');
            document.getElementById('submitBtn').disabled = false;
        }
    });
</script>